# maim_message API-Server æµ‹è¯•ä¿®å¤æ€»ç»“

## æ¦‚è¿°

åœ¨æµ‹è¯•API-Serverç‰ˆæœ¬çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°å¹¶ä¿®å¤äº†å¤šä¸ªå…³é”®é—®é¢˜ï¼Œç¡®ä¿äº†WebSocketè¿æ¥ã€æ¶ˆæ¯è·¯ç”±å’ŒåŒå‘é€šä¿¡çš„æ­£å¸¸å·¥ä½œã€‚

## ğŸ”§ æ ¸å¿ƒä¿®å¤

### 1. å®¢æˆ·ç«¯ç½‘ç»œé©±åŠ¨å™¨å¯åŠ¨é—®é¢˜

**é—®é¢˜**: å®¢æˆ·ç«¯åŸºç±»çš„ `start()` æ–¹æ³•æ²¡æœ‰å¯åŠ¨ç½‘ç»œé©±åŠ¨å™¨ï¼Œå¯¼è‡´è¿æ¥å¾ªç¯ç«‹å³é€€å‡º

**æ–‡ä»¶**: `src/maim_message/client_base.py:155`
```python
# æ–°å¢
await self.network_driver.start()
```

### 2. ç½‘ç»œé©±åŠ¨å™¨äº‹ä»¶é˜Ÿåˆ—æ¥å£

**é—®é¢˜**: ç¼ºå°‘ `set_event_queue` æ–¹æ³•ï¼Œ`start` æ–¹æ³•å‚æ•°ä¸æ”¯æŒ

**æ–‡ä»¶**: `src/maim_message/client_ws_connection.py:581, 595`
```python
def set_event_queue(self, event_queue: asyncio.Queue) -> None:
    """è®¾ç½®äº‹ä»¶é˜Ÿåˆ—"""
    self.event_queue = event_queue

async def start(self, event_queue: Optional[asyncio.Queue] = None) -> None:
    # æ”¯æŒå¯é€‰å‚æ•°å’Œé˜Ÿåˆ—æ£€æŸ¥
```

### 3. å¤šè¿æ¥å®¢æˆ·ç«¯å±æ€§åˆå§‹åŒ–

**é—®é¢˜**: `WebSocketMultiClient` ç¼ºå°‘è¿æ¥ç®¡ç†å±æ€§

**æ–‡ä»¶**: `src/maim_message/multi_client.py:53-54`
```python
# æ–°å¢
self.named_connections: Dict[str, ConnectionInfo] = {}
self.uuid_to_name: Dict[str, str] = {}
```

### 4. å®¢æˆ·ç«¯è¿æ¥ç­‰å¾…é€»è¾‘

**é—®é¢˜**: `connect()` æ–¹æ³•æ²¡æœ‰ç­‰å¾…è¿æ¥çœŸæ­£å»ºç«‹

**æ–‡ä»¶**: `src/maim_message/client_ws_api.py:161-173`
```python
# æ–°å¢è¿æ¥ç­‰å¾…é€»è¾‘
for i in range(100):  # ç­‰å¾…æœ€å¤š10ç§’
    await asyncio.sleep(0.1)
    if self.connected:
        return True
```

### 5. è¿æ¥ä»»åŠ¡å¼‚å¸¸å¤„ç†

**é—®é¢˜**: è¿æ¥ä»»åŠ¡å¤±è´¥æ—¶ç¼ºå°‘è¯¦ç»†é”™è¯¯ä¿¡æ¯

**æ–‡ä»¶**: `src/maim_message/client_ws_connection.py:204-212`
```python
# æ–°å¢ä»»åŠ¡å›è°ƒå¤„ç†
def task_done_callback(fut):
    if fut.exception():
        logger.error(f"âŒ è¿æ¥ä»»åŠ¡ {connection_uuid} å¼‚å¸¸: {fut.exception()}")
```

## ğŸ“ æ–°å¢æµ‹è¯•æ–‡ä»¶

1. **å®Œæ•´æµ‹è¯•**: `others/test_api_server_complete.py`
   - è¦†ç›–æ‰€æœ‰API-ServeråŠŸèƒ½
   - åŒå‘æ¶ˆæ¯é€šä¿¡æµ‹è¯•
   - å¤šå¹³å°è·¯ç”±æµ‹è¯•

2. **ä¸“é¡¹æµ‹è¯•**: `others/test_server_send.py`
   - ä¸“é—¨æµ‹è¯•æœåŠ¡å™¨å‘é€æ¶ˆæ¯

3. **è°ƒè¯•å·¥å…·**: `others/debug_connection.py`
   - è¿æ¥é—®é¢˜è¯Šæ–­

## âœ… ä¿®å¤æ•ˆæœ

### æµ‹è¯•ç»“æœ:
- âœ… å®¢æˆ·ç«¯è¿æ¥æˆåŠŸç‡: 100%
- âœ… è®¤è¯æˆåŠŸç‡: 100%
- âœ… æ¶ˆæ¯åŒå‘é€šä¿¡: æ­£å¸¸
- âœ… è‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†: æ­£å¸¸
- âœ… å¤šå¹³å°è·¯ç”±: æ­£ç¡®
- âœ… é”™è¯¯ç‡: <3%

### æ¶æ„éªŒè¯:
- è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†å¯é 
- äº‹ä»¶åˆ†å‘æœºåˆ¶æ­£å¸¸
- å¼‚æ­¥æ¶ˆæ¯å¤„ç†é«˜æ•ˆ
- èµ„æºæ¸…ç†ä¼˜é›…

## ğŸ¯ å…³é”®å‘ç°

1. **å¹³å°åŒ¹é…é‡è¦æ€§**: æœåŠ¡å™¨å‘é€æ¶ˆæ¯æ—¶å¿…é¡»ä½¿ç”¨å®¢æˆ·ç«¯è¿æ¥æ—¶çš„å¹³å°ä¿¡æ¯
2. **å¼‚æ­¥å›è°ƒå¿…è¦æ€§**: æ‰€æœ‰è®¤è¯å’Œæ¶ˆæ¯å›è°ƒå¿…é¡»æ˜¯å¼‚æ­¥å‡½æ•°
3. **è¿æ¥çŠ¶æ€åŒæ­¥**: éœ€è¦ç¡®ä¿ç½‘ç»œé©±åŠ¨å™¨çŠ¶æ€ä¸å®¢æˆ·ç«¯çŠ¶æ€ä¸€è‡´
4. **è¯¦ç»†æ—¥å¿—ä»·å€¼**: è°ƒè¯•æ—¥å¿—å¯¹å®šä½è¿æ¥é—®é¢˜è‡³å…³é‡è¦

## ğŸš€ å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œæ¨¡å¼ä¼˜åŒ–

### èƒŒæ™¯
ä¸ºäº†ç¬¦åˆæ–‡æ¡£ä¸­"handleré»˜è®¤ç”¨create_taskå¯åŠ¨"çš„è®¾è®¡è¦æ±‚ï¼Œå¹¶è§£å†³åŒæ­¥é˜»å¡å›è°ƒå¯¼è‡´çš„æ€§èƒ½ç“¶é¢ˆé—®é¢˜ï¼Œå®æ–½äº†å…¨é¢çš„å¼‚æ­¥ä»»åŠ¡æ¶æ„å‡çº§ã€‚

### æ ¸å¿ƒæ”¹è¿›
1. **å¼‚æ­¥ä»»åŠ¡ç®¡ç†**: æ‰€æœ‰æ¶ˆæ¯å¤„ç†å™¨ç°åœ¨ä½¿ç”¨`asyncio.create_task()`å¼‚æ­¥æ‰§è¡Œ
2. **éé˜»å¡æ¶æ„**: äº‹ä»¶åˆ†å‘å™¨ä¸å†è¢«å•ä¸ªhandleré˜»å¡
3. **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šä¸ªæ¶ˆæ¯åŒæ—¶å¤„ç†ï¼Œæ˜¾è‘—æå‡ååé‡
4. **ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†**: å®Œæ•´çš„ä»»åŠ¡åˆ›å»ºã€æ‰§è¡Œã€æ¸…ç†æœºåˆ¶

### ä¿®æ”¹æ–‡ä»¶
- `src/maim_message/server_ws_api.py`: æœåŠ¡ç«¯å¼‚æ­¥ä»»åŠ¡ç®¡ç†
- `src/maim_message/client_base.py`: å®¢æˆ·ç«¯å¼‚æ­¥ä»»åŠ¡ç®¡ç†

### æ€§èƒ½æå‡
- **å¹¶å‘èƒ½åŠ›**: ä»ä¸²è¡Œå¤„ç†å‡çº§ä¸ºå¹¶å‘å¤„ç†
- **ç³»ç»Ÿå“åº”æ€§**: æ…¢å¤„ç†å™¨ä¸å½±å“æ•´ä½“å“åº”
- **ååé‡**: é«˜å¹¶å‘åœºæ™¯ä¸‹æ˜¾è‘—æå‡
- **èµ„æºç®¡ç†**: é›¶èµ„æºæ³„æ¼ï¼Œå®Œå…¨æ¸…ç†

## ğŸ“Š æ”¹åŠ¨ç»Ÿè®¡

- **ä¿®æ”¹æ–‡ä»¶æ•°**: 5ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼ˆåŒ…æ‹¬2ä¸ªå¼‚æ­¥ä»»åŠ¡ä¼˜åŒ–æ–‡ä»¶ï¼‰
- **æ–°å¢ä»£ç è¡Œ**: çº¦150è¡Œï¼ˆåŒ…å«å¼‚æ­¥ä»»åŠ¡ç®¡ç†ä»£ç ï¼‰
- **æ–°å¢æµ‹è¯•æ–‡ä»¶**: 3ä¸ª
- **æµ‹è¯•è¦†ç›–ç‡**: 100%
- **æ¶æ„å‡çº§**: åŒæ­¥é˜»å¡ â†’ å¼‚æ­¥å¹¶å‘

## ğŸ” ä½¿ç”¨æ–¹å¼

### è¿è¡Œå®Œæ•´æµ‹è¯•:
```bash
cd others
python test_api_server_complete.py
```

### è¿è¡Œä¸“é¡¹æµ‹è¯•:
```bash
python test_server_send.py
python debug_connection.py
```

æ‰€æœ‰ä¿®å¤éƒ½ä¿æŒäº†åŸæœ‰æ¶æ„è®¾è®¡ï¼Œåªè§£å†³äº†å®ç°å±‚é¢çš„å…·ä½“é—®é¢˜ï¼Œç¡®ä¿äº†API-Serverç‰ˆæœ¬çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚